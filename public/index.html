<html ng-app="voting">
<head>
  <title>Mittens</title>
  <link href="bootstrap.css" rel="stylesheet" type="text/css">
  <style>
    .feed {
      margin-left: 100px;
      margin-right: 100px;
      margin-top: 50px;
      min-height: 1000px;
    }
    .feed h3 {
      padding: 20px;
    }
    .page-title{
      margin-left: 100px;
    }
    .new-meow{
      padding: 20px;
    }
    .chart{
      padding: 100px;
    }
    </style>
    <script type = "text/javascript" src="angular.min.js"></script>
    <script type = "text/javascript" src="angular-route.js"></script>
    <script type = "text/javascript" src="angular-cookies.js"></script>
    <script src="Chart.bundle.min.js"></script>

    <script type="text/javascript">
    var app = angular.module('voting',['ngRoute', 'ngCookies']);

    app.config(function($routeProvider, $locationProvider){
      $locationProvider.hashPrefix('');

      $routeProvider
      .when('/', {
        templateUrl: '/home.html',
        controller: 'VotingCtrl'
      })
      .when('/signup',{
        templateUrl: '/signup.html' ,
        controller: 'signupController'
      })
      .when('/viewpolls/:id',{
        templateUrl: '/polldisplay.html',
        controller: 'pollDisplayController'
      });
    });
    app.run(function($rootScope, $cookies){
      if ($cookies.get('token') && $cookies.get('currentUser')){
        $rootScope.token = $cookies.get('token');
        $rootScope.currentUser = $cookies.get('currentUser');
      }
    });
    app.controller('pollDisplayController', function($routeParams, $scope, $http){
      $scope.answer = {
        text: '',
        options: '',
        optionSelected: ''
      }
      $scope.updateOptions = function (){
        for (var i = 0; i < $scope.options.length; ++i){
          if ($scope.options[i] === $scope.answer.optionSelected){
              $scope.optionscount[i]+=1;
              $scope.answer.text = $scope.data.text;
              $scope.data.options[i][1]+=1;
              console.log($scope.data);
            $http.put('/polls/update', $scope.data).then(function(){
              getChart();
            });
            }
        }
      }
      function getChart () {
        var ctx = document.getElementById("myChart").getContext('2d');
        var options = {
          responsive: true,
          maintainAspectRatio: true
        }

      var myChart = new Chart(ctx, {
          type: 'pie',
          options: options,
          data: {
            labels: $scope.options,
            datasets: [{
              backgroundColor: $scope.colors,
              data: $scope.optionscount
            }]
          }
        });
      }
      $scope.id = $routeParams.id;

      $http.get('/pollresults', {
        params: {poll: $routeParams.id}
      }).then(function(response){
          $scope.data = response.data;
          $scope.options = [];
          $scope.optionscount = [];
          $scope.colors = [];
          for (var i = 0; i < $scope.data.options.length; ++i){
            $scope.options[i] = $scope.data.options[i][0];
            $scope.optionscount[i] = $scope.data.options[i][1];
            $scope.colors[i] = "#"+((1<<24)*Math.random()|0).toString(16);
          }
        //   var ctx = document.getElementById("myChart").getContext('2d');
        //         var options
        //         var myChart = new Chart(ctx, {
        //     type: 'pie',
        //     data: {
        //       labels: $scope.options,
        //       datasets: [{
        //         backgroundColor: $scope.colors,
        //         data: $scope.optionscount
        //       }]
        //     }
        //   });
        // $scope.id = $routeParams.id;
        //
        // });
        getChart();

    });

  });
    app.controller('VotingCtrl', function ($rootScope, $scope, $http, $cookies){

    $scope.ids = [];
    $scope.options=[];

    $scope.addOptions = function() {
      var newItemNo = $scope.ids.length;
      $scope.options.push([]);
      $scope.options[newItemNo][1] = 0;
      $scope.ids.push(newItemNo);
      console.log($scope.options);
    };
    $scope.removePoll = function(poll){
      $http.put('/polls/remove', {poll: poll}).then(function(){
        getPolls();
      });
    };

    $scope.submitNewPoll = function(){
      $http.post('/polls', {newPoll: $scope.newPoll, newPollEncoded: encodeURI($scope.newPoll), options: $scope.options}).then(function(){
        $scope.newPoll = ''
        var i;
        for(i = 0; i < $scope.options.length; ++i){
          $scope.options[i] = ''
        }
        getPolls();
      });
    };
    $scope.signin = function(){
      $http.put('/users/signin', {users: $scope.username, password: $scope.password}).then(function(res){
        alert('successfully signed in');
        $cookies.put('token', res.data.token);
        $cookies.put('currentUser', $scope.username);
        $rootScope.token = res.data.token;
        $rootScope.currentUser = $scope.username;
      }, function(err){
        alert('bad login credentials');
      });
    }
    function getPolls(){
      $http.get('/polls').then(function(response){
          $scope.polls = response.data;
        });
      }

      getPolls();
    });
    app.controller('signupController', function ($scope, $http){
      $scope.submitSignup = function(){
        var newUser = {
          username: $scope.username,
          password: $scope.password,
        };
        $http.post('/users', newUser).then(function(){
          alert('success');
        });
      }
    });
    </script>
</head>
<body>
  <h1><a href ="#/">Voting App</a></h1>
  <div ng-view></div>
</body>
</html>
